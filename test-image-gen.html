<!DOCTYPE html>
<html>
<head>
    <title>Image Generation Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #0a0a0a;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            cursor: pointer;
        }
        button:hover {
            background: #555;
        }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        textarea {
            width: 100%;
            height: 100px;
            background: #0a0a0a;
            color: #00ff00;
            border: 1px solid #333;
            padding: 10px;
            font-family: monospace;
        }
        input {
            width: 100%;
            padding: 8px;
            background: #0a0a0a;
            color: #00ff00;
            border: 1px solid #333;
            margin: 5px 0;
        }
        img {
            max-width: 100%;
            border: 2px solid #333;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üîç Nanobanna Pro - Image Generation Debugger</h1>

    <div class="test-section">
        <h2>1. API Key Configuration</h2>
        <label>Gemini API Key:</label>
        <input type="password" id="geminiKey" placeholder="Enter your Gemini API key">
        <button onclick="testApiKey()">Test Connection</button>
        <div id="keyTestResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Model ID Verification</h2>
        <label>Model ID:</label>
        <input type="text" id="modelId" value="gemini-3-pro-image-preview">
        <button onclick="listModels()">List Available Models</button>
        <div id="modelListResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Simple Image Generation Test</h2>
        <label>Prompt:</label>
        <textarea id="testPrompt">A professional LinkedIn banner background, deep blue with geometric patterns, 1584x396 pixels, high quality, 4k</textarea>
        <label>Size:</label>
        <select id="testSize">
            <option value="1K">1K</option>
            <option value="2K">2K</option>
            <option value="4K">4K</option>
        </select>
        <button onclick="testImageGeneration()">Generate Test Image</button>
        <div id="genTestResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Error Log</h2>
        <div id="errorLog" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script type="module">
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@0.21.0';

        window.logError = function(message, data) {
            const log = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="error">[${timestamp}] ${message}</div>`;
            if (data) {
                log.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        };

        window.logSuccess = function(message) {
            const log = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="success">[${timestamp}] ‚úì ${message}</div>`;
        };

        window.logWarning = function(message) {
            const log = document.getElementById('errorLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="warning">[${timestamp}] ‚ö† ${message}</div>`;
        };

        window.testApiKey = async function() {
            const resultDiv = document.getElementById('keyTestResult');
            const apiKey = document.getElementById('geminiKey').value;

            if (!apiKey) {
                resultDiv.innerHTML = '<span class="error">‚ùå Please enter an API key</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="warning">Testing connection...</span>';

            try {
                const ai = new GoogleGenAI({ apiKey });

                window.logSuccess('GoogleGenAI client created successfully');

                // Test with a simple text generation
                const response = await ai.models.generateContent({
                    model: 'gemini-2.0-flash-exp',
                    contents: [{ parts: [{ text: 'Say "API test successful"' }] }]
                });

                const text = response.text || response.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    resultDiv.innerHTML = '<span class="success">‚úì API Key Valid!</span>';
                    window.logSuccess('API test successful: ' + text);
                    localStorage.setItem('gemini_api_key', apiKey);
                } else {
                    resultDiv.innerHTML = '<span class="error">‚ùå Unexpected response format</span>';
                    window.logError('Unexpected response', response);
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå ${error.message}</span>`;
                window.logError('API test failed', error);
            }
        };

        window.listModels = async function() {
            const resultDiv = document.getElementById('modelListResult');
            const apiKey = document.getElementById('geminiKey').value || localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                resultDiv.innerHTML = '<span class="error">‚ùå Please set API key first</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="warning">Fetching models...</span>';

            try {
                const ai = new GoogleGenAI({ apiKey });

                // Try to list models (may not be supported in all SDK versions)
                try {
                    const models = await ai.models.list();
                    resultDiv.innerHTML = '<span class="success">‚úì Available models:</span><pre>' +
                        JSON.stringify(models, null, 2) + '</pre>';
                    window.logSuccess('Models listed successfully');
                } catch (listError) {
                    // If list is not supported, show known models
                    resultDiv.innerHTML = `
                        <span class="warning">‚ö† Model listing not supported in this SDK version</span><br>
                        <strong>Known Image Models (try these):</strong><br>
                        - gemini-3-pro-image-preview (NEW - 4K, 14 refs)<br>
                        - imagen-3.0-generate-001 (Imagen 3.0)<br>
                        - imagen-3.0-fast-generate-001 (Imagen 3.0 Fast)<br>
                        - gemini-2.0-flash-exp (Experimental)<br>
                    `;
                    window.logWarning('Model list API not available: ' + listError.message);
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå ${error.message}</span>`;
                window.logError('Failed to list models', error);
            }
        };

        window.testImageGeneration = async function() {
            const resultDiv = document.getElementById('genTestResult');
            const apiKey = document.getElementById('geminiKey').value || localStorage.getItem('gemini_api_key');
            const modelId = document.getElementById('modelId').value;
            const prompt = document.getElementById('testPrompt').value;
            const size = document.getElementById('testSize').value;

            if (!apiKey) {
                resultDiv.innerHTML = '<span class="error">‚ùå Please set API key first</span>';
                return;
            }

            if (!prompt) {
                resultDiv.innerHTML = '<span class="error">‚ùå Please enter a prompt</span>';
                return;
            }

            resultDiv.innerHTML = '<span class="warning">üé® Generating image... (this may take 10-30 seconds)</span>';
            window.logSuccess(`Starting generation with model: ${modelId}, size: ${size}`);

            try {
                const ai = new GoogleGenAI({ apiKey });

                const safePrompt = `Professional LinkedIn Banner, 1584x396 pixels ratio (approx 4:1 aspect), high quality. ${prompt}`;

                window.logSuccess('Calling API with prompt: ' + safePrompt);

                const response = await ai.models.generateContent({
                    model: modelId,
                    contents: [{
                        role: 'user',
                        parts: [{ text: safePrompt }]
                    }],
                    config: {
                        imageConfig: {
                            imageSize: size,
                            aspectRatio: "16:9"
                        }
                    }
                });

                window.logSuccess('API response received');

                // Log full response structure for debugging
                console.log('Full Response:', response);
                window.logSuccess('Response structure logged to console');

                // Extract image
                let imageFound = false;
                const candidates = response.candidates || [];

                for (const candidate of candidates) {
                    const parts = candidate.content?.parts || [];
                    for (const part of parts) {
                        if (part.inlineData) {
                            const base64Data = part.inlineData.data;
                            const imageUrl = `data:image/png;base64,${base64Data}`;
                            resultDiv.innerHTML = `
                                <span class="success">‚úì Image generated successfully!</span><br>
                                <img src="${imageUrl}" alt="Generated">
                            `;
                            window.logSuccess('Image extracted and displayed');
                            imageFound = true;
                            break;
                        }
                    }
                    if (imageFound) break;
                }

                if (!imageFound) {
                    resultDiv.innerHTML = `<span class="error">‚ùå No image found in response</span>`;
                    window.logError('Response structure did not contain image', response);
                }

            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Generation failed: ${error.message}</span>`;
                window.logError('Image generation error', {
                    message: error.message,
                    stack: error.stack,
                    fullError: error
                });
            }
        };

        // Auto-load saved API key
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) {
            document.getElementById('geminiKey').value = savedKey;
            window.logSuccess('Loaded saved API key from localStorage');
        }
    </script>
</body>
</html>
